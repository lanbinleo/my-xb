name: Build Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest

    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Get version from tag
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Build
        run: |
          mkdir -p dist

          # 构造输出文件名（不包含版本号）
          OUT="dist/myxb_${{ matrix.goos }}_${{ matrix.goarch }}"

          # Windows 需要加入 .exe
          if [ "${{ matrix.goos }}" = "windows" ]; then
            OUT="${OUT}.exe"
          fi

          echo "Building ${OUT}"

          # 使用 ldflags 注入版本号（去掉 v 前缀）
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
          go build -ldflags "-X main.version=${VERSION#v}" -o "$OUT" ./cmd/myxb

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: myxb-${{ matrix.goos }}-${{ matrix.goarch }}-${{ env.VERSION }}
          path: dist/*

  release:
    name: Create Draft Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Get version from tag
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: myxb-*
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/*
          name: Release ${{ env.VERSION }}
          body: |
            ## Installation

            Download the appropriate binary for your platform:

            | Operating System | Architecture | File to Download |
            |-----------------|--------------|------------------|
            | Windows (64-bit) | x86_64 | `myxb_windows_amd64.exe` |
            | macOS (Intel) | x86_64 | `myxb_darwin_amd64` |
            | macOS (Apple Silicon) | ARM64 (M1/M2/M3/M4) | `myxb_darwin_arm64` |
            | Linux (64-bit) | x86_64 | `myxb_linux_amd64` |
            | Linux (ARM64) | ARM64 | `myxb_linux_arm64` |

            ### Verify checksums
            ```bash
            sha256sum -c SHA256SUMS
            ```

            ---

            **Note:** For the vast majority of users, you can download any program compiled with v1.0.2 and later. This is because the program comes with an update system.

